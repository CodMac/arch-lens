# Go-TreeSitter Dependency Analyzer

ä¸€ä¸ªåŸºäº **Tree-sitter** çš„é«˜æ€§èƒ½ã€æ’ä»¶åŒ–å¤šè¯­è¨€æºç ä¾èµ–åˆ†æå¼•æ“ã€‚

è¯¥å·¥å…·æ—¨åœ¨é€šè¿‡ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰è§£æï¼Œè·¨è¶Šç‰©ç†æ–‡ä»¶è¾¹ç•Œï¼Œæ„å»ºå‡ºåŒ…å«**å±‚çº§ç»“æ„ï¼ˆContainmentï¼‰ä¸é€»è¾‘å¼•ç”¨ï¼ˆLogic Dependencyï¼‰çš„å®Œæ•´ä»£ç çŸ¥è¯†å›¾è°±ã€‚è™½ç„¶ç›®å‰ä»¥ Java ä¸ºé¦–ä¸ªæ·±åº¦æ”¯æŒçš„è¯­è¨€ï¼Œä½†å…¶æ ¸å¿ƒæ¡†æ¶è®¾è®¡ä¸ºè¯­è¨€æ— å…³**ã€‚

## ğŸ—ï¸ æ ¸å¿ƒæ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨è§£è€¦çš„**ä¸‰é˜¶æ®µå¤„ç†æµæ°´çº¿**ï¼Œç¡®ä¿äº†åœ¨å¤æ‚ç¬¦å·è§£æä¸‹çš„é«˜æ€§èƒ½è¡¨ç°ï¼š

1. **Phase 1: ç¬¦å·æ”¶é›† (Collection)**ï¼šå¹¶å‘æ‰«ææ–‡ä»¶ï¼Œæå–ç±»ã€æ–¹æ³•ã€å˜é‡å®šä¹‰ï¼Œæ„å»ºå…¨å±€ç¬¦å·ç´¢å¼•ï¼ˆGlobal Contextï¼‰ã€‚
2. **Phase 2: å±‚æ¬¡è¡¥å…¨ (Stitching)**ï¼šæ ¹æ®åŒ…ååŠè·¯å¾„ï¼Œè‡ªåŠ¨ç»‡å…¥ `Package -> File -> Class` çš„ç‰©ç†ä¸é€»è¾‘å½’å±å…³ç³»ã€‚
3. **Phase 3: å…³ç³»æå– (Extraction)**ï¼šåŸºäº Tree-sitter Query æ•è·åŠ¨ä½œï¼ˆå¦‚ Call, Createï¼‰ï¼Œå¹¶åˆ©ç”¨**ç»§æ‰¿é“¾ç®—æ³•**è¿›è¡Œç²¾ç¡®çš„ç¬¦å·æ¶ˆæ­§ã€‚

---

## ğŸ“‚ æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å— | è·¯å¾„ | èŒè´£ |
| --- | --- | --- |
| **Model** | `/model` | å®šä¹‰é€šç”¨çš„ä»£ç å…ƒç´ ã€ä½ç½®ä¿¡æ¯åŠå…³ç³»ç±»å‹ï¼ˆè¯­è¨€æ— å…³ï¼‰ã€‚ |
| **Parser** | `/parser` | å°è£… Tree-sitter è§£æé€»è¾‘ï¼Œæä¾› AST æ ¼å¼åŒ–è¾“å‡ºå·¥å…·ã€‚ |
| **Context** | `/context` | ç»´æŠ¤å…¨å±€ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰ï¼Œæä¾›è·¨æ–‡ä»¶çš„ç¬¦å·æŸ¥æ‰¾èƒ½åŠ›ã€‚ |
| **Processor** | `/processor` | æ ¸å¿ƒè°ƒåº¦å¼•æ“ï¼Œè´Ÿè´£é©±åŠ¨ä¸‰é˜¶æ®µæµæ°´çº¿çš„å¹¶å‘æ‰§è¡Œã€‚ |
| **Language Extensions** | `/x` | è¯­è¨€ç‰¹å®šå®ç°ï¼ˆå¦‚ `/x/java`ï¼‰ï¼ŒåŒ…å«è¯¥è¯­è¨€çš„æ”¶é›†å™¨ã€æå–å™¨åŠè§£æè§„åˆ™ã€‚ |

---

## ğŸ“Š æ•°æ®æ¨¡å‹ (Data Model)

åˆ†æå™¨çš„è¾“å‡ºç”± **CodeElementï¼ˆèŠ‚ç‚¹ï¼‰** å’Œ **DependencyRelationï¼ˆè¾¹ï¼‰** ç»„æˆã€‚

### 1. CodeElement (ä»£ç å…ƒç´ )

```go
type CodeElement struct {
    Name          string       // å…ƒç´ åç§° (å¦‚: getUser)
    Kind          ElementKind  // ç±»å‹ (Class, Method, Field, etc.)
    QualifiedName string       // å…¨é™å®šå (å¦‚: com.auth.Service.getUser)
    Path          string       // ç›¸å¯¹æ–‡ä»¶è·¯å¾„
    Location      *Location    // è¡Œåˆ—ä½ç½®ä¿¡æ¯
    Signature     string       // åŸå§‹ä»£ç ç­¾å
}

```

### 2. DependencyRelation (ä¾èµ–å…³ç³»)

åœ¨åˆ†æå™¨ä¸­ï¼Œ`CodeElement` æ˜¯å›¾è®ºä¸­çš„**é¡¶ç‚¹**ï¼Œè€Œ `DependencyRelation` åˆ™æ˜¯å¸¦æƒçš„æœ‰å‘**è¾¹**ï¼Œè®°å½•äº†å‘èµ·æ–¹ï¼ˆSourceï¼‰ä¸ç›®æ ‡æ–¹ï¼ˆTargetï¼‰çš„ç²¾ç¡®è¯­ä¹‰å…³è”ã€‚

```go
type DependencyRelation struct {
    Type     RelationType // å…³ç³»ç±»å‹ (å¦‚ CALL, EXTEND)
    Source   *CodeElement // å‘èµ·æ–¹ (å¦‚ï¼šè°ƒç”¨è€…æ–¹æ³•)
    Target   *CodeElement // ç›®æ ‡æ–¹ (å¦‚ï¼šè¢«è°ƒç”¨çš„æ–¹æ³•)
    Location *Location    // å…³ç³»å‘ç”Ÿçš„ç²¾ç¡®æºç ä½ç½®
}

```

#### å…³ç³»åˆ†ç±»è¯¦è¿°

| åˆ†ç±» | ç±»å‹ | è¯­ä¹‰è¯´æ˜        | æ•æ‰åœºæ™¯ç¤ºä¾‹                                    |
| --- | - |-------------|-------------------------------------------|
| **ç»„ç»‡ç»“æ„** | **CONTAIN** | é€»è¾‘å±‚çº§åŒ…å«/æˆå‘˜å½’å± | åŒ…åŒ…å«ç±»ã€æ–‡ä»¶åŒ…å«ç±»ã€ç±»åŒ…å«æ–¹æ³•ã€ç±»åŒ…å«å­—æ®µ                    |
| **å®šä¹‰ä¾èµ–** | **EXTEND** | ç»§æ‰¿å…³ç³»        | ç±»ç»§æ‰¿ã€æ¥å£ç»§æ‰¿ï¼ˆæ”¯æŒè·¨æ–‡ä»¶è¿½è¸ªï¼‰                         |
|  | **IMPLEMENT** | å®ç°å…³ç³»        | ç±»å®ç°æ¥å£                                     |
|  | **PARAMETER** | å‚æ•°ä¾èµ–        | æ–¹æ³•ç­¾åä¸­çš„å…¥å‚ç±»å‹                                |
|  | **RETURN** | è¿”å›å€¼ä¾èµ–       | æ–¹æ³•ç­¾åä¸­çš„è¿”å›ç±»å‹                                |
|  | **ANNOTATION** | å…ƒæ•°æ®å¼•ç”¨       | ç±»æˆ–æ–¹æ³•ä¸Šæ ‡æ³¨çš„æ³¨è§£                                |
| **é€»è¾‘åŠ¨ä½œ** | **CALL** | æ–¹æ³•/å‡½æ•°è°ƒç”¨     | 1. `obj.save()` 2. `super()` è°ƒç”¨ 3. é™æ€å¯¼å…¥è°ƒç”¨ |
|  | **CREATE** | å®ä¾‹åŒ–         | `new UserService()` æ•è·                    |
|  | **USE** | æˆå‘˜è®¿é—®        | è®¿é—®å­—æ®µæˆ–é™æ€å¸¸é‡                                 |
|  | **CAST** | ç±»å‹å¼ºè½¬        | `(User) obj` ä¸­çš„ç±»å‹ä¾èµ–                       |

---

## ğŸ› ï¸ è¯­è¨€ç‰¹æ€§æ”¯æŒ

### Java ç‰¹æ€§ (Current)

* **ç°ä»£è¯­æ³•**: æ·±åº¦æ”¯æŒ **Java 17+ Record**ï¼ˆè‡ªåŠ¨ç”Ÿæˆéšå¼è®¿é—®å™¨ã€è§£æç´§å‡‘æ„é€ å‡½æ•°ï¼‰ã€‚
* **ç¬¦å·æ¶ˆæ­§**: è‡ªåŠ¨å¤„ç† `java.lang` éšå¼å¯¼å…¥ã€`static` å¯¼å…¥åŠ `.*` é€šé…ç¬¦å¯¼å…¥ã€‚
* **ç»§æ‰¿é“¾è§£æ**: é€’å½’æœç´¢çˆ¶ç±»/æ¥å£ï¼Œç²¾å‡†å®šä½ `this.xxx` æˆ– `super.yyy` æˆå‘˜çš„çœŸå®æ¥æºã€‚
* **å†…ç½®è¿‡æ»¤**: å†…ç½® `NoiseFilter`ï¼Œè‡ªåŠ¨å±è”½ JDK å†…éƒ¨å™ªéŸ³ï¼ˆ`sun.*`ï¼‰åŠå¸¸ç”¨å·¥å…·ï¼ˆ`lombok`, `slf4j`ï¼‰ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¼•å…¥ä¸åˆå§‹åŒ–

```go
import (
    "github.com/CodMac/go-treesitter-dependency-analyzer/processor"
    "github.com/CodMac/go-treesitter-dependency-analyzer/model"
    _ "github.com/CodMac/go-treesitter-dependency-analyzer/x/java" // æ˜¾å¼æ³¨å†Œ Java æ’ä»¶
)

func main() {
    // åˆ›å»ºå¤„ç†å™¨ï¼šæŒ‡å®šè¯­è¨€ã€æ˜¯å¦å¯¼å‡ºå¹¶æ ¼å¼åŒ–ASTã€å¹¶å‘æ•°
    fp := processor.NewFileProcessor(model.LangJava, true, true, 8)

    // æ‰§è¡Œåˆ†æï¼šä¼ å…¥é¡¹ç›®æ ¹ç›®å½•åŠç›®æ ‡æ–‡ä»¶åˆ—è¡¨
    rels, gCtx, err := fp.ProcessFiles("./my-project", files)
}

```

---

## ğŸ¤ å¼€æºè´¡çŒ®ï¼šå¦‚ä½•å¿«é€Ÿå¼€å‘æ–°è¯­è¨€æ’ä»¶ï¼Ÿ

æœ¬é¡¹ç›®é€šè¿‡ `x/` ç›®å½•å®ç°æ’ä»¶åŒ–ã€‚è‹¥è¦å¢åŠ å¯¹ **Go, Python, C++** ç­‰è¯­è¨€çš„æ”¯æŒï¼Œä»…éœ€å››æ­¥ï¼š

1. **å®šä¹‰ Language**: åœ¨ `model/language.go` ä¸­å¢åŠ è¯­è¨€æ ‡è¯†ã€‚
2. **å®ç° Collector**: å®šä¹‰å¦‚ä½•ä»è¯¥è¯­è¨€çš„ AST ä¸­è¯†åˆ«â€œå®šä¹‰â€ï¼ˆå®šä¹‰æ”¶é›†é€»è¾‘ï¼‰ã€‚
3. **å®ç° Extractor**: ç¼–å†™ Tree-sitter Query å®šä¹‰å¦‚ä½•æ•è·åŠ¨ä½œå‹ä¾èµ–ï¼ˆå¦‚ Call, Createï¼‰ã€‚
4. **å®ç° SymbolResolver**: å®šä¹‰è¯¥è¯­è¨€çš„ä½œç”¨åŸŸè§„åˆ™ï¼ˆå¦‚ Go çš„é¦–å­—æ¯å¯è§æ€§ï¼‰ã€‚
5. **æ³¨å†Œæ’ä»¶**: åœ¨æ–°åŒ…çš„ `init()` ä¸­æ³¨å†Œä¸Šè¿°å®ç°ã€‚

> **æç¤º**ï¼šå¯åˆ©ç”¨ `/parser` æä¾›çš„ `formatSExpression` å·¥å…·å°†ç›®æ ‡è¯­è¨€ AST å¯¼å‡ºï¼Œè¾…åŠ©ç¼–å†™ Queryã€‚

---

## ğŸ“œ License

æœ¬é¡¹ç›®åŸºäº [MIT License](https://www.google.com/search?q=LICENSE) åè®®å¼€æºã€‚